/*
 * This source file was generated by the Gradle 'init' task
 */
package org.example;

import ticket.booking.entities.Train;
import ticket.booking.entities.User;
import ticket.booking.services.UserBookingService;
import ticket.booking.utils.UserServiceUtil;

import java.io.IOException;
import java.util.*;

public class App {

    public static void main(String[] args) throws IOException {
        Scanner scanner = new Scanner(System.in);
        UserBookingService userBookingService;

        System.out.println("ğŸš† Welcome to IRCTC Express Booking System ğŸš‰");
        System.out.println("==============================================");

        try {
            userBookingService = new UserBookingService();
        } catch (IOException ex) {
            System.out.println("âŒ Initialization failed: " + ex.getMessage());
            return;
        }

        int option = 0;
        Train trainSelectedForBooking = null;

        while (option != 7) {
            System.out.println("\nğŸ”˜ Choose an option:");
            System.out.println("1ï¸âƒ£  Sign Up");
            System.out.println("2ï¸âƒ£  Login");
            System.out.println("3ï¸âƒ£  View My Bookings");
            System.out.println("4ï¸âƒ£  Search Trains");
            System.out.println("5ï¸âƒ£  Book a Seat");
            System.out.println("6ï¸âƒ£  Cancel a Booking");
            System.out.println("7ï¸âƒ£  Exit");

            try {
                option = Integer.parseInt(scanner.nextLine().trim());
            } catch (NumberFormatException e) {
                System.out.println("âš ï¸ Please enter a valid number.");
                continue;
            }

            switch (option) {
                case 1:
                    System.out.println("ğŸ“ Sign Up");
                    String username;
                    while (true) {
                        System.out.print("ğŸ‘¤ Enter a username: ");
                        username = scanner.nextLine().trim();
                        if (username.contains(" ")) {
                            System.out.println("âš ï¸ Username should not contain spaces.");
                        } else {
                            break;
                        }
                    }

                    System.out.print("ğŸ” Enter your password: ");
                    String password = scanner.nextLine();

                    User newUser = new User(username, password,
                            UserServiceUtil.hashPassword(password),
                            new ArrayList<>(),
                            UUID.randomUUID().toString());

                    if (userBookingService.signUp(newUser)) {
                        System.out.println("âœ… Signup complete. You can now login!");
                    }
                    break;

                case 2:
                    System.out.println("ğŸ” Login");
                    System.out.print("ğŸ‘¤ Username: ");
                    String loginUser = scanner.nextLine().trim();

                    System.out.print("ğŸ”‘ Password: ");
                    String loginPass = scanner.nextLine();

                    Optional<User> existing = userBookingService.getUserByUsername(loginUser);
                    if (existing.isPresent() && UserServiceUtil.checkPassword(loginPass, existing.get().getHashedPassword())) {
                        System.out.println("âœ… Login successful. Welcome, " + loginUser + "!");
                        userBookingService.setUser(existing.get());
                    } else {
                        System.out.println("âŒ Invalid credentials. Please try again.");
                    }
                    break;

                case 3:
                    System.out.println("ğŸ“„ My Bookings:");
                    userBookingService.fetchBookings();
                    break;

                case 4:
                    System.out.println("ğŸš‰ Search Trains");

                    System.out.print("Enter source station: ");
                    String source = scanner.nextLine().toLowerCase();

                    System.out.print("Enter destination station: ");
                    String destination = scanner.nextLine().toLowerCase();

                    List<Train> trains = userBookingService.getTrains(source, destination);

                    if (trains.isEmpty()) {
                        System.out.println("ğŸš« No trains found from " + source + " to " + destination);
                        break;
                    }

                    System.out.println("\nğŸ“‹ Available Trains:");
                    for (int i = 0; i < trains.size(); i++) {
                        Train t = trains.get(i);
                        System.out.println("ğŸ”¢ " + (i + 1) + ". Train ID: " + t.getTrainId() + " | No: " + t.getTrainNo());
                        System.out.println("   ğŸ“ Route: " + String.join(" â ", t.getStations()));
                        System.out.println("   â±ï¸ Timings:");
                        for (Map.Entry<String, String> time : t.getStationTimes().entrySet()) {
                            System.out.println("     ğŸ•’ " + time.getKey() + " - " + time.getValue());
                        }
                    }

                    System.out.print("\nğŸ‘‰ Choose a train (1 - " + trains.size() + "): ");
                    int selectedTrain = scanner.nextInt();
                    scanner.nextLine(); // consume newline

                    if (selectedTrain < 1 || selectedTrain > trains.size()) {
                        System.out.println("â— Invalid train selection.");
                        break;
                    }

                    trainSelectedForBooking = trains.get(selectedTrain - 1);
                    System.out.println("âœ… Train Selected: " + trainSelectedForBooking.getTrainId());

                    System.out.println("ğŸ’º Seat Layout (0 = Available, 1 = Booked):");
                    for (List<Integer> row : trainSelectedForBooking.getSeats()) {
                        row.forEach(seat -> System.out.print((seat == 0 ? "ğŸŸ©" : "ğŸŸ¥") + " "));
                        System.out.println();
                    }
                    break;

                case 5:
                    if (trainSelectedForBooking == null) {
                        System.out.println("âš ï¸ Please search and select a train first (option 4).");
                        break;
                    }

                    System.out.println("ğŸ« Booking Seat - Available Layout:");
                    List<List<Integer>> layout = userBookingService.fetchSeats(trainSelectedForBooking);
                    for (List<Integer> row : layout) {
                        row.forEach(seat -> System.out.print((seat == 0 ? "T" : "F") + " "));
                        System.out.println();
                    }

                    System.out.print("Enter Row: ");
                    int row = scanner.nextInt();
                    System.out.print("Enter Column: ");
                    int col = scanner.nextInt();
                    scanner.nextLine(); // consume newline

                    System.out.println("ğŸ”„ Booking in progress...");
                    if (userBookingService.bookTrainSeat(trainSelectedForBooking, row, col)) {
                        System.out.println("âœ… Seat booked successfully! ğŸ§¾");
                    } else {
                        System.out.println("âŒ Could not book the selected seat.");
                    }
                    break;

                case 6:
                    System.out.print("ğŸ§¾ Enter Ticket ID to cancel: ");
                    String ticketId = scanner.nextLine();
                    if (userBookingService.cancelBooking(ticketId)) {
                        System.out.println("âŒ Ticket canceled successfully.");
                    } else {
                        System.out.println("ğŸš« No matching ticket found.");
                    }
                    break;

                case 7:
                    System.out.println("ğŸ‘‹ Thank you for using IRCTC Express! Safe travels! ğŸ§³");
                    break;

                default:
                    System.out.println("âš ï¸ Invalid choice. Please choose between 1 and 7.");
            }
        }
    }
}


